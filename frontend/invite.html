<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚€è¯·è¿”ä½£ - PhotoTree</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .benefits {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #856404;
            font-size: 14px;
        }

        .benefit-item:last-child {
            margin-bottom: 0;
        }

        .generate-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            display: none;
            text-align: center;
        }

        .invite-code {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            letter-spacing: 4px;
            margin: 16px 0;
        }

        .invite-url {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
            word-break: break-all;
            margin-bottom: 16px;
        }

        .qrcode-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #qrcode {
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .copy-btn {
            padding: 12px 24px;
            font-size: 14px;
            color: white;
            background: #28a745;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .back-link {
            display: block;
            text-align: center;
            color: white;
            text-decoration: none;
            margin-top: 20px;
            opacity: 0.8;
        }

        .back-link:hover {
            opacity: 1;
        }

        .login-prompt {
            text-align: center;
            padding: 40px 20px;
        }

        .login-prompt p {
            margin-bottom: 20px;
            color: #666;
        }

        .login-btn {
            padding: 14px 40px;
            font-size: 16px;
            color: white;
            background: #07c160;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .share-tip {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #1565c0;
            margin-top: 16px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° é‚€è¯·è¿”ä½£</h1>
            <p>åˆ†äº«ä¸“å±é“¾æ¥ï¼Œå¥½å‹ä»˜è´¹æ‚¨å¾—30%è¿”ä½£</p>
        </div>

        <!-- æœªç™»å½•æç¤º -->
        <div class="card" id="login-card" style="display: none;">
            <div class="login-prompt">
                <p>è¯·å…ˆç™»å½•åç”Ÿæˆä¸“å±é‚€è¯·é“¾æ¥</p>
                <button class="login-btn" onclick="goLogin()">å¾®ä¿¡ç™»å½•</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="card" id="main-card" style="display: none;">
            <div class="card-title">ğŸ æ¨å¹¿å¥–åŠ±</div>

            <div class="benefits">
                <div class="benefit-item">
                    <span>ğŸ’¸</span>
                    <span>å¥½å‹é€šè¿‡æ‚¨çš„é“¾æ¥ä»˜è´¹ï¼Œæ‚¨è·å¾— <strong>30%</strong> è¿”ä½£</span>
                </div>
                <div class="benefit-item">
                    <span>âš¡</span>
                    <span>è¿”ä½£ç›´æ¥åˆ°æ‚¨çš„ <strong>å¾®ä¿¡é›¶é’±</strong>ï¼Œç§’åˆ°è´¦</span>
                </div>
                <div class="benefit-item">
                    <span>â™¾ï¸</span>
                    <span>æ— æ¨å¹¿æ•°é‡é™åˆ¶ï¼Œæ¨å¹¿è¶Šå¤šèµšè¶Šå¤š</span>
                </div>
            </div>

            <!-- ç”ŸæˆæŒ‰é’® -->
            <div id="generate-section">
                <button class="generate-btn" onclick="generateInviteCode()">
                    ğŸ« ç”Ÿæˆæˆ‘çš„ä¸“å±é‚€è¯·é“¾æ¥
                </button>
            </div>

            <!-- ç»“æœå±•ç¤º -->
            <div class="result-section" id="result-section">
                <p style="color: #28a745; font-weight: 600;">âœ… æ‚¨çš„ä¸“å±é‚€è¯·ç </p>
                <div class="invite-code" id="invite-code"></div>

                <div class="invite-url" id="invite-url"></div>

                <div class="qrcode-container">
                    <div id="qrcode"></div>
                </div>

                <div>
                    <button class="copy-btn" onclick="copyUrl()">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                    <button class="copy-btn" style="background: #17a2b8;" onclick="saveQrCode()">ğŸ’¾ ä¿å­˜äºŒç»´ç </button>
                </div>

                <div class="share-tip">
                    ğŸ’¡ æç¤ºï¼šé•¿æŒ‰äºŒç»´ç å¯ä¿å­˜åˆ°ç›¸å†Œï¼Œåˆ†äº«åˆ°æœ‹å‹åœˆæˆ–å‘ç»™å¥½å‹
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ•°æ® -->
        <div class="card" id="stats-card" style="display: none;">
            <div class="card-title">ğŸ“Š æˆ‘çš„æ¨å¹¿æ•°æ®</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="stat-registered">0</div>
                    <div class="stat-label">æ³¨å†Œäººæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-paid">0</div>
                    <div class="stat-label">ä»˜è´¹äººæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-earnings">Â¥0</div>
                    <div class="stat-label">å·²è·æ”¶ç›Š</div>
                </div>
            </div>
        </div>

        <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
    </div>

    <script>
        const API_BASE = 'https://www.aiguess.cn';
        let currentOpenid = null;
        let currentUrl = '';

        // é¡µé¢åŠ è½½
        window.addEventListener('load', async () => {
            // è·å–ç”¨æˆ·ä¿¡æ¯
            const userInfo = getUserInfo();

            if (!userInfo || !userInfo.openid) {
                // æœªç™»å½•
                document.getElementById('login-card').style.display = 'block';
                return;
            }

            currentOpenid = userInfo.openid;
            document.getElementById('main-card').style.display = 'block';
            document.getElementById('stats-card').style.display = 'block';

            // åŠ è½½ç°æœ‰æ•°æ®
            await loadMyStats();
        });

        // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä» localStorageï¼‰
        function getUserInfo() {
            const stored = localStorage.getItem('userInfo');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        // è·³è½¬ç™»å½•
        function goLogin() {
            // è®°å½•æ¥æºé¡µé¢
            localStorage.setItem('redirectAfterLogin', '/invite.html');
            window.location.href = '/'; // è·³è½¬åˆ°é¦–é¡µè¿›è¡Œå¾®ä¿¡ç™»å½•
        }

        // ç”Ÿæˆé‚€è¯·ç 
        async function generateInviteCode() {
            const btn = document.querySelector('.generate-btn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/referral/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ openid: currentOpenid })
                });

                const data = await response.json();

                if (data.success) {
                    showResult(data.code, data.url);
                    await loadMyStats();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    btn.disabled = false;
                    btn.textContent = 'ğŸ« ç”Ÿæˆæˆ‘çš„ä¸“å±é‚€è¯·é“¾æ¥';
                }
            } catch (err) {
                alert('è¯·æ±‚å¤±è´¥ï¼š' + err.message);
                btn.disabled = false;
                btn.textContent = 'ğŸ« ç”Ÿæˆæˆ‘çš„ä¸“å±é‚€è¯·é“¾æ¥';
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(code, url) {
            document.getElementById('generate-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';

            document.getElementById('invite-code').textContent = code;
            document.getElementById('invite-url').textContent = url;
            currentUrl = url;

            // ç”ŸæˆäºŒç»´ç 
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            new QRCode(qrcodeContainer, {
                text: url,
                width: 180,
                height: 180
            });
        }

        // åŠ è½½æˆ‘çš„ç»Ÿè®¡æ•°æ®
        async function loadMyStats() {
            try {
                const response = await fetch(`${API_BASE}/api/referral/my-stats?openid=${currentOpenid}`);
                const data = await response.json();

                if (data.success && data.hasCode) {
                    // æ˜¾ç¤ºå·²æœ‰çš„é‚€è¯·ç 
                    showResult(data.code, data.url);

                    // æ›´æ–°ç»Ÿè®¡
                    document.getElementById('stat-registered').textContent = data.stats.registeredUsers;
                    document.getElementById('stat-paid').textContent = data.stats.paidUsers;
                    document.getElementById('stat-earnings').textContent = 'Â¥' + data.stats.totalEarnings;
                }
            } catch (err) {
                console.error('Load stats error:', err);
            }
        }

        // å¤åˆ¶é“¾æ¥
        function copyUrl() {
            navigator.clipboard.writeText(currentUrl).then(() => {
                alert('âœ… é“¾æ¥å·²å¤åˆ¶ï¼\n\n' + currentUrl);
            }).catch(() => {
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶ï¼š', currentUrl);
            });
        }

        // ä¿å­˜äºŒç»´ç 
        function saveQrCode() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'invite-qrcode.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else {
                alert('è¯·å…ˆç”ŸæˆäºŒç»´ç ');
            }
        }
    </script>
</body>

</html>